<!DOCTYPE html>
<html>
<head>
    <title>Voter Authentication</title>
    <style>
        .container {
            text-align: center;
            margin-top: 20px;
        }
        #video, #canvas {
            border: 2px solid #333;
            margin: 10px;
        }
        #capturedPhoto {
            margin: 10px;
            max-width: 640px;
            display: none;
        }
        #status {
            margin: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #voteButton {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            display: none;
        }
    </style>
    <!--  face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/dist/face-api.js"></script>
</head>
<body>
    <div class="container">
        <h2>Voter Photo Authentication</h2>
        
        <!-- Video feed -->
        <video id="video" width="640" height="480" autoplay></video>
        
        <!-- Canvas for capturing photo -->
        <canvas id="canvas" width="640" height="480" style="display: none;"></canvas>
        
        <!-- Display captured photo -->
        <img id="capturedPhoto" alt="Captured photo will appear here">
        
        <div>
            <button id="capture">Capture Photo</button>
            <button id="voteButton">Vote Now</button>
        </div>
        
        <div id="status">Please capture your photo</div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedPhoto = document.getElementById('capturedPhoto');
        const ctx = canvas.getContext('2d');
        const captureButton = document.getElementById('capture');
        const voteButton = document.getElementById('voteButton');
        const status = document.getElementById('status');

        let isModelLoaded = false;
        let matchFound = false;

        // voters to vote for
        const voterIds = ['12345', '12346'];

        // Add this right after the voterIds declaration
        console.log("Registered voter IDs:", voterIds);

        // Updated loadModels function with new CDN path
        async function loadModels() {
            status.textContent = "Starting to load models...";
            try {
                console.log("Loading SSD MobileNet model...");
                await faceapi.nets.ssdMobilenetv1.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/model/');
                console.log("SSD MobileNet loaded successfully");

                console.log("Loading Face Landmark model...");
                await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/model/');
                console.log("Face Landmark model loaded successfully");

                console.log("Loading Face Recognition model...");
                await faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/model/');
                console.log("Face Recognition model loaded successfully");

                isModelLoaded = true;
                status.textContent = "Model loaded. Camera starting...";
                console.log(" model loaded successfully");
            } catch (error) {
                console.error("Detailed error loading models:", error);
                status.textContent = "❌ Error loading face detection models";
            }
        }

        // Start video stream
        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                status.textContent = "Camera ready. Please capture your photo.";
            } catch (error) {
                console.error("Camera access denied:", error);
                status.textContent = "❌ Camera access denied. Please enable camera permissions.";
            }
        }

        // Start everything
        async function initialize() {
            await loadModels();
            await startVideo();
        }

        initialize();

        // Modified capture photo function
        captureButton.addEventListener('click', async () => {
            console.log("Current model status:", isModelLoaded);
            if (!isModelLoaded) {
                status.textContent = "Please wait for models to load...";
                console.log("Models not yet loaded. Attempting to load again...");
                await loadModels();
                return;
            }

            // Draw video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            try {
                // Detect face in the captured image
                const detections = await faceapi.detectSingleFace(canvas)
                    .withFaceLandmarks()
                    .withFaceDescriptor();
                
                if (!detections) {
                    status.textContent = "❌ No face detected. Please try again.";
                    return;
                }

                // Show captured photo
                capturedPhoto.src = canvas.toDataURL('image/jpeg');
                capturedPhoto.style.display = 'block';
                
                let matchFound = false;
                let atLeastOnePhotoProcessed = false;

                // Try matching with each voter photo
                for (const voterId of voterIds) {
                    const voterImage = new Image();
                    voterImage.src = `/static/images/reference_photos/voter_photos/${voterId}.jpg`;
                    console.log("Attempting to load image from:", voterImage.src);
                    
                    try {
                        await new Promise((resolve, reject) => {
                            voterImage.onload = async () => {
                                try {
                                    const voterCanvas = document.createElement('canvas');
                                    voterCanvas.width = voterImage.width;
                                    voterCanvas.height = voterImage.height;
                                    const voterCtx = voterCanvas.getContext('2d');
                                    voterCtx.drawImage(voterImage, 0, 0);

                                    const voterDetections = await faceapi.detectSingleFace(voterCanvas)
                                        .withFaceLandmarks()
                                        .withFaceDescriptor();

                                    if (voterDetections) {
                                        atLeastOnePhotoProcessed = true;
                                        const distance = faceapi.euclideanDistance(
                                            detections.descriptor,
                                            voterDetections.descriptor
                                        );

                                        console.log(`Face match distance for voter ${voterId}:`, distance);
                                        
                                        if (distance < 0.6) {
                                            matchFound = true;
                                            resolve();
                                            return;
                                        }
                                    }
                                    resolve();
                                } catch (error) {
                                    console.error(`Error processing voter photo ${voterId}:`, error);
                                    reject(error);
                                }
                            };
                            
                            voterImage.onerror = (error) => {
                                console.error(`Error loading voter photo ${voterId}:`, error);
                                console.log("Failed to load:", voterImage.src);
                                reject(error);
                            };
                        });

                    } catch (error) {
                        console.error(`Error processing voter ${voterId}:`, error);
                        continue;
                    }

                    // Add this in the face matching loop
                    console.log(`Processing voter ID ${voterId}, match status: ${matchFound}`);
                }

                // Update UI based on match result
                if (!atLeastOnePhotoProcessed) {
                    status.textContent = "❌ Error: No reference photos could be processed";
                    voteButton.style.display = 'none';
                    return;
                }

                if (matchFound) {
                    voteButton.style.display = 'inline-block';
                    status.textContent = "✅ Identity verified! You can now vote.";
                } else {
                    voteButton.style.display = 'none';
                    status.textContent = "❌ Face not recognized. Please try again.";
                }

            } catch (error) {
                console.error("Error during face detection:", error);
                status.textContent = "❌ Error verifying identity. Please try again.";
            }
        });

        // Navigate to ListVoters.html 
        voteButton.addEventListener('click', () => {
            window.location.href = 'ListVoters.html';
        });
    </script>
</body>
</html>

